{% extends "base.html" %}
{% block title %}曲別ランキング | 根性カラオキランキング{% endblock %}

{% block head %}
  <style>
    .table-wrap{overflow-x:auto}
    .col-date{min-width: 140px;}
    @media (max-width:720px){ .col-date{min-width: 160px;} }

    /* 個人サマリの3項目をきれいに並べる */
    .stats-row{display:flex; gap:12px; flex-wrap:wrap}
    .stat-chip{
      padding:6px 10px; border-radius:999px; font-size:12px;
      background:rgba(34,197,94,.1); border:1px solid rgba(34,197,94,.35); color:#86efac;
    }
    .stat-chip.gray{
      background:rgba(148,163,184,.08); border-color:rgba(148,163,184,.3); color:#cbd5e1;
    }
    .stat-chip.cyan{
      background:rgba(6,182,212,.10); border-color:rgba(6,182,212,.35); color:#67e8f9;
    }
  </style>
{% endblock %}

{% block update_hidden %}
  <input type="hidden" name="song" value="{{ song_query }}">
  <input type="hidden" name="singer" value="{{ singer_query }}">
{% endblock %}

{% block content %}
  <div class="h1">曲別ランキング</div>

  {# 人ごとの統計（平均・1位取得数・合計曲数） + 全体ユニーク曲数 #}
  {% if user_averages or first_place_counts or user_unique_song_counts %}
    <div class="card" style="margin-bottom:16px">
      <div class="stats-row">
        {% set users = (user_averages.keys() | list) %}
        {% for uname in users %}
          <div class="chip" style="background:rgba(14,165,233,.15); border-color:rgba(14,165,233,.35); color:#7dd3fc;">
            {{ uname }}
          </div>
          <span class="stat-chip">平均：{{ '%.2f'|format(user_averages.get(uname, 0)) }}</span>
          <span class="stat-chip cyan">1位取得：{{ first_place_counts.get(uname, 0) }}</span>
          <span class="stat-chip gray">合計曲数：{{ user_unique_song_counts.get(uname, 0) }}</span>
        {% endfor %}
        {% if total_unique_songs %}
          <span class="stat-chip" style="margin-left:auto">全体ユニーク曲：{{ total_unique_songs }}</span>
        {% endif %}
      </div>
    </div>
  {% endif %}

  <!-- 検索フォーム -->
  <form class="card" method="get" action="{{ url_for('ranking') }}" style="margin-bottom:16px">
    <div class="grid cols-3">
      <div>
        <label for="song">曲名検索</label>
        <input type="text" id="song" name="song" placeholder="例：PERFECT HUMAN" value="{{ song_query }}">
      </div>
      <div>
        <label for="singer">歌手名検索</label>
        <input type="text" id="singer" name="singer" placeholder="例：三浦たくま" value="{{ singer_query }}">
      </div>
      <div>
        <label>並び替え</label>
        <input type="text" value="1位スコアの降順" readonly>
      </div>
    </div>
    <div class="row" style="margin-top:12px; justify-content:flex-end">
      <a class="btn secondary" href="{{ url_for('ranking') }}">条件クリア</a>
      <button class="btn" type="submit">検索</button>
    </div>
  </form>

  {% if ranking_list %}
    {% for item in ranking_list %}
      <div class="song card">
        <div class="song-head">
          <div>
            <div class="song-title">{{ item.song }}</div>
            {% if item.singer %}
              <div class="artist">歌手名：<span class="chip">{{ item.singer }}</span></div>
            {% endif %}
          </div>
          <div class="muted" style="font-size:12px">Top 3</div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:60px">順位</th>
                <th style="min-width:140px">ユーザー</th>
                <th style="min-width:100px">スコア</th>
                <th class="col-date">日付</th>
              </tr>
            </thead>
            <tbody>
              {% for record in item.records %}
                <tr>
                  <td class="rank">
                    {% if loop.index == 1 %}<span class="medal-1">🥇 1位</span>
                    {% elif loop.index == 2 %}<span class="medal-2">🥈 2位</span>
                    {% else %}<span class="medal-3">🥉 3位</span>{% endif %}
                  </td>
                  <td>{{ record["ユーザー"] }}</td>
                  <td>{{ '%.2f'|format(record["スコア"]) }}</td>
                  <td>
                    {% if record["日付"] %}
                      {{ record["日付"].strftime('%Y-%m-%d') }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="card">
      <div class="muted">ランキングデータはまだありません。右上の「ランキング更新」から取り込んでください。</div>
    </div>
  {% endif %}
{% endblock %}