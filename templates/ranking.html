{% extends "base.html" %}
{% block title %}æ›²åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚° | æ ¹æ€§ã‚«ãƒ©ã‚ªã‚­ãƒ©ãƒ³ã‚­ãƒ³ã‚°{% endblock %}

{% block head %}
  <style>
    .table-wrap{overflow-x:auto}
    .col-date{min-width: 140px;}
    @media (max-width:720px){ .col-date{min-width: 160px;} }

    .user-cards{
      display:grid; gap:12px;
      grid-template-columns: repeat(4, 1fr);
      margin-bottom:16px;
    }
    @media (max-width:1120px){ .user-cards{grid-template-columns: 1fr 1fr 1fr} }
    @media (max-width:920px){ .user-cards{grid-template-columns: 1fr 1fr} }
    @media (max-width:640px){ .user-cards{grid-template-columns: 1fr} }
    .user-card .name{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px; margin-bottom:6px; }
    .user-card .name .dot{ width:10px; height:10px; border-radius:999px; box-shadow:0 0 16px rgba(34,197,94,.35); }
    .user-card .stats{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ padding:8px 10px; border-radius:12px; font-weight:700; font-size:13px; background:rgba(17,24,39,.66); border:1px solid var(--border); }
    .pill.acc{background:rgba(34,197,94,.10); border-color:rgba(34,197,94,.35); color:#86efac}
    .pill.cyan{background:rgba(6,182,212,.10); border-color:rgba(6,182,212,.35); color:#67e8f9}
    .pill.gray{background:rgba(148,163,184,.08); border-color:rgba(148,163,184,.30); color:#cbd5e1}

    /* å…¥åŠ›ã‚’å¸¸ã«è¦‹ã‚„ã™ãï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã‚‚16pxã€ãƒ¢ãƒã‚¤ãƒ«ã¯ã•ã‚‰ã«æ‹¡å¤§ï¼‰ */
    input[type="text"], select { padding: 12px 14px; font-size: 16px; width:100%; }
    .name-link{ color:var(--text); text-decoration:none; }
    .name-link:hover{ text-decoration:underline; }

    .score{ font-weight:900; letter-spacing:.2px; text-shadow:0 0 12px rgba(34,197,94,.18); }

    /* â˜… ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ï¼šæ¤œç´¢æ¬„ã‚’1åˆ—ã«ã—ã¦ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
    @media (max-width: 640px) {
      .grid.cols-3{ grid-template-columns: 1fr; }
      input[type="text"], select { padding: 14px 16px; font-size: 18px; }
      .btn, .btn.secondary { padding: 12px 18px; font-size: 16px; }
    }
  </style>
{% endblock %}

{% block update_hidden %}
  <input type="hidden" name="song" value="{{ song_query }}">
  <input type="hidden" name="singer" value="{{ singer_query }}">
{% endblock %}

{% block content %}
  <div class="h1" style="display:flex; align-items:center; justify-content:space-between;">
    <span>æ›²åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
    <a href="{{ url_for('home') }}" class="btn secondary" style="font-size:14px; padding:6px 12px;">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
  </div>

  {% set users_fixed = ['ã¾ã¤ã‚Šã','ãˆã™','ã“ã‚“ã‘ã‚'] %}
  <div class="user-cards">
    {% for uname in users_fixed %}
      <div class="user-card card">
        <div class="name">
          {% set color =
             'background:linear-gradient(180deg,#22c55e,#16a34a);' if uname=='ã¾ã¤ã‚Šã' else
             'background:linear-gradient(180deg,#06b6d4,#0891b2);' if uname=='ãˆã™' else
             'background:linear-gradient(180deg,#a78bfa,#7c3aed);' %}
          <span class="dot" style="{{ color }}"></span>
          <a class="name-link" href="{{ url_for('user_history', username=uname) }}">{{ uname }}</a>
        </div>
        <div class="stats">
          <div class="pill acc">å¹³å‡ <span class="score">{{ '%.3f'|format(user_averages.get(uname, 0)) }}</span></div>
          <div class="pill cyan">1ä½ <span class="score">{{ first_place_counts.get(uname, 0) }}</span></div>
          <a class="pill name-link" href="{{ url_for('user_third_rank', username=uname) }}">3ä½ <span class="score">{{ third_place_counts.get(uname, 0) }}</span></a>
          <div class="pill gray">æ›²æ•° <span class="score">{{ user_total_records.get(uname, 0) }}</span></div>
        </div>
      </div>
    {% endfor %}
    <div class="user-card card">
      <div class="name">
        <span class="dot" style="background:linear-gradient(180deg,#f59e0b,#b45309)"></span>
        <a class="name-link" href="{{ url_for('all_history') }}">å…¨ä½“</a>
      </div>
      <div class="stats">
        <a class="pill" href="{{ url_for('all_history') }}">å…¨ä½“ã®å±¥æ­´ã‚’è¦‹ã‚‹</a>
      </div>
    </div>
  </div>

  <form class="card" method="get" action="{{ url_for('ranking') }}" style="margin-bottom:16px">
    <div class="grid cols-3">
      <div>
        <label for="song">æ›²åæ¤œç´¢</label>
        <input type="text" id="song" name="song" placeholder="ä¾‹ï¼šPERFECT HUMAN" value="{{ song_query }}">
      </div>
      <div>
        <label for="singer">æ­Œæ‰‹åæ¤œç´¢</label>
        <input type="text" id="singer" name="singer" placeholder="ä¾‹ï¼šä¸‰æµ¦ãŸãã¾" value="{{ singer_query }}">
      </div>
      <div>
        <label>ä¸¦ã³æ›¿ãˆ</label>
        <input type="text" value="1ä½ã‚¹ã‚³ã‚¢ã®é™é †" readonly>
      </div>
    </div>
    <div class="row" style="margin-top:12px; justify-content:flex-end">
      <a class="btn secondary" href="{{ url_for('ranking') }}">æ¡ä»¶ã‚¯ãƒªã‚¢</a>
      <button class="btn" type="submit">æ¤œç´¢</button>
    </div>
  </form>

  {% if ranking_list %}
    {% for item in ranking_list %}
      <div class="song card">
        <div class="song-head">
          <div>
            <div class="song-title">{{ item.song }}</div>
            {% if item.singer %}
              <div class="artist">æ­Œæ‰‹åï¼š<span class="chip">{{ item.singer }}</span></div>
            {% endif %}
          </div>
          <div class="muted" style="font-size:12px">Top 3</div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:60px">é †ä½</th>
                <th style="min-width:140px">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                <th style="min-width:100px">ã‚¹ã‚³ã‚¢</th>
                <th class="col-date">æ—¥ä»˜</th>
              </tr>
            </thead>
            <tbody>
              {% for record in item.records %}
                <tr>
                  <td class="rank">
                    {% if loop.index == 1 %}<span class="medal-1">ğŸ¥‡ 1ä½</span>
                    {% elif loop.index == 2 %}<span class="medal-2">ğŸ¥ˆ 2ä½</span>
                    {% else %}<span class="medal-3">ğŸ¥‰ 3ä½</span>{% endif %}
                  </td>
                  <td>
                    <a class="name-link" href="{{ url_for('user_history', username=record['ãƒ¦ãƒ¼ã‚¶ãƒ¼']) }}">
                      {{ record["ãƒ¦ãƒ¼ã‚¶ãƒ¼"] }}
                    </a>
                  </td>
                  <td><span class="score">{{ '%.3f'|format(record["ã‚¹ã‚³ã‚¢"]) }}</span></td>
                  <!-- æŒ‡ç¤ºã«ã‚ˆã‚Šæ›²åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æ—¥ä»˜ã¯ YYYY-MM-DD ã®ã¾ã¾ -->
                  <td>{{ record["æ—¥ä»˜"]|fmtdate }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="card">
      <div class="muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ã€ã‹ã‚‰å–ã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚</div>
    </div>
  {% endif %}
{% endblock %}
