{% extends "base.html" %}
{% block title %}æ›²åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚° | æ ¹æ€§ã‚«ãƒ©ã‚ªã‚­ãƒ©ãƒ³ã‚­ãƒ³ã‚°{% endblock %}

{% block head %}
  <style>
    /* æ—¥ä»˜åˆ—ã‚’ã‚„ã‚„åºƒã’ã€ãƒ¢ãƒã‚¤ãƒ«ã§ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
    .table-wrap{overflow-x:auto}
    .col-date{min-width: 140px;} /* ã“ã“ã‚’åºƒã’ã‚‹ï¼šå¿…è¦ãªã‚‰ 160px ã¾ã§OK */
    @media (max-width:720px){
      .col-date{min-width: 160px;}
    }
  </style>
{% endblock %}

{% block update_hidden %}
  <input type="hidden" name="song" value="{{ song_query }}">
  <input type="hidden" name="singer" value="{{ singer_query }}">
  <input type="hidden" name="sort" value="{{ sort_order }}">
{% endblock %}

{% block content %}
  <div class="h1">æ›²åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>

  {# â‘¡ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼å¹³å‡ç‚¹ã®è¡¨ç¤ºï¼ˆæœ€é«˜ç‚¹å¹³å‡ã§ãªãå…¨ãƒ‡ãƒ¼ã‚¿å¹³å‡ï¼‰ #}
  {% if user_averages %}
    <div class="card" style="margin-bottom:16px">
      <div class="row" style="gap:12px; flex-wrap:wrap">
        {% for uname, avg in user_averages.items() %}
          <div class="chip" style="background:rgba(34,197,94,.1); border-color:rgba(34,197,94,.35); color:#86efac;">
            {{ uname }} ã®å¹³å‡ï¼š{{ '%.2f'|format(avg) }}
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form class="card" method="get" action="{{ url_for('ranking') }}" style="margin-bottom:16px">
    <div class="grid cols-3">
      <div>
        <label for="song">æ›²åæ¤œç´¢</label>
        <input type="text" id="song" name="song" placeholder="ä¾‹ï¼šPERFECT HUMAN" value="{{ song_query }}">
      </div>
      <div>
        <label for="singer">æ­Œæ‰‹åæ¤œç´¢</label>
        <input type="text" id="singer" name="singer" placeholder="ä¾‹ï¼šä¸‰æµ¦ãŸãã¾" value="{{ singer_query }}">
      </div>
      <div>
        <label for="sort">ä¸¦ã³æ›¿ãˆï¼ˆã‚ã„ã†ãˆãŠï¼‰</label>
        <select name="sort" id="sort">
          <option value="asc"  {% if sort_order=='asc' %}selected{% endif %}>æ˜‡é †</option>
          <option value="desc" {% if sort_order=='desc' %}selected{% endif %}>é™é †</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:12px; justify-content:flex-end">
      <a class="btn secondary" href="{{ url_for('ranking') }}">æ¡ä»¶ã‚¯ãƒªã‚¢</a>
      <button class="btn" type="submit">æ¤œç´¢</button>
    </div>
  </form>

  {% if ranking_data %}
    {% for song, records in ranking_data.items() %}
      <div class="song card">
        <div class="song-head">
          <div>
            <div class="song-title">{{ song }}</div>
            {% if records and records[0]["æ­Œæ‰‹å"] %}
              <div class="artist">æ­Œæ‰‹åï¼š<span class="chip">{{ records[0]["æ­Œæ‰‹å"] }}</span></div>
            {% endif %}
          </div>
          <div class="muted" style="font-size:12px">Top 3</div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:60px">é †ä½</th>
                <th style="min-width:140px">ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                <th style="min-width:100px">ã‚¹ã‚³ã‚¢</th>
                <th class="col-date">æ—¥ä»˜</th>
              </tr>
            </thead>
            <tbody>
              {% for record in records %}
                <tr>
                  <td class="rank">
                    {% if loop.index == 1 %}<span class="medal-1">ğŸ¥‡ 1ä½</span>
                    {% elif loop.index == 2 %}<span class="medal-2">ğŸ¥ˆ 2ä½</span>
                    {% else %}<span class="medal-3">ğŸ¥‰ 3ä½</span>{% endif %}
                  </td>
                  <td>{{ record["ãƒ¦ãƒ¼ã‚¶ãƒ¼"] }}</td>
                  <td>{{ '%.2f'|format(record["ã‚¹ã‚³ã‚¢"]) }}</td>
                  <td>
                    {# â‘ ï¼šæ—¥ä»˜ã¯ YYYY-MM-DD ã®ã¿è¡¨ç¤ºï¼ˆDBã«ã¯æ™‚é–“ã‚‚ä¿æŒï¼‰ #}
                    {% if record["æ—¥ä»˜"] %}
                      {{ record["æ—¥ä»˜"].strftime('%Y-%m-%d') }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="card">
      <div class="muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ã€ã‹ã‚‰å–ã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚</div>
    </div>
  {% endif %}
{% endblock %}