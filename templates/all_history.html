{% extends "base.html" %}
{% block title %}全体の履歴 | 根性カラオキランキング{% endblock %}

{% block head %}
  <style>
    .table-wrap{overflow-x:auto}

    /* テーブルを固定レイアウトにして折返し制御 */
    table{ width:100%; border-collapse:separate; border-spacing:0 8px; table-layout:fixed; }
    th, td { vertical-align:middle; padding:10px 12px; }

    /* 列幅：曲名/スコア/ユーザーは見やすく、歌手名/日付は横スクロールで見える程度 */
    .col-title { min-width:220px; }
    .col-score { min-width:120px; }
    .col-user  { min-width:130px; }
    .col-singer{ min-width:160px; }
    .col-date  { min-width:160px; }

    /* 検索欄：常にフル幅＆タップしやすいサイズ */
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    .controls .field{min-width:240px; flex:1}
    label{font-size:12px}
    input[type="text"], select {
      width:100%; padding:14px 16px; font-size:16px; min-height:46px;
    }

    /* 曲名・スコアは1行固定（省略記号で省略） */
    .nowrap{ white-space:nowrap; }
    .truncate{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:inline-block;
      max-width: 420px;
    }
    @media (max-width: 1024px){ .truncate{ max-width: 300px; } }
    @media (max-width: 768px) { .truncate{ max-width: 230px; } }
    @media (max-width: 480px) { .truncate{ max-width: 165px; } }

    /* スコアをコンパクト表示（枠は残す） */
    .score.compact{ padding:2px 6px; }

    /* ユーザーチップ */
    .uname-chip{
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700;
      border:1px solid var(--border);
    }
    .chip-green { background:rgba(34,197,94,.10);  border-color:rgba(34,197,94,.35);  color:#86efac }
    .chip-cyan  { background:rgba(6,182,212,.10);  border-color:rgba(6,182,212,.35);  color:#67e8f9 }
    .chip-violet{ background:rgba(167,139,250,.10);border-color:rgba(167,139,250,.35);color:#c4b5fd }

    /* 行の色バー */
    .bar-green { box-shadow: inset 3px 0 0 #22c55e; }
    .bar-cyan  { box-shadow: inset 3px 0 0 #06b6d4; }
    .bar-violet{ box-shadow: inset 3px 0 0 #a78bfa; }

    /* ページネーション */
    .pager{ display:flex; gap:8px; justify-content:flex-end; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .pager .info{ color:var(--muted); font-size:12px; }

    /* モバイル微調整 */
    @media (max-width: 640px){
      th, td { padding:8px 10px; font-size:14px; }
      label{ font-size:12px; }
      input[type="text"], select { font-size:16px; min-height:46px; }
      .col-title{ min-width:200px; }
      .col-score{ min-width:110px; }
      .col-user { min-width:120px; }
      .col-singer{ min-width:150px; }
      .col-date  { min-width:150px; }
    }
    @media (max-width: 380px){
      .truncate{ max-width: 150px; }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="h1" style="display:flex; align-items:center; justify-content:space-between;">
    <span>全体の履歴</span>
    <a class="btn secondary" href="{{ url_for('ranking') }}" style="font-size:14px; padding:6px 12px;">曲別ランキングへ</a>
  </div>

  <form method="get" class="card" style="margin-bottom:16px">
    <div class="controls">
      <div class="field">
        <label>曲名検索</label>
        <input type="text" name="song" value="{{ song_query }}" placeholder="例：千本桜">
      </div>
      <div class="field">
        <label>歌手名検索</label>
        <input type="text" name="singer" value="{{ singer_query }}" placeholder="例：米津玄師">
      </div>
      <div class="field" style="max-width:220px">
        <label>並び替え</label>
        <select name="sort">
          <option value="recent" {% if sort=='recent' %}selected{% endif %}>最近歌った順</option>
          <option value="score" {% if sort=='score' %}selected{% endif %}>得点が高い順</option>
          <option value="score_low" {% if sort=='score_low' %}selected{% endif %}>得点が低い順</option>
          <option value="oldest" {% if sort=='oldest' %}selected{% endif %}>古い順</option>
        </select>
      </div>
      <div class="field" style="max-width:160px">
        <label>件数/ページ</label>
        <select name="per">
          {% for p in [10,20,50,100,200] %}
            <option value="{{ p }}" {% if per==p %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px">
        <a class="btn secondary" href="{{ url_for('all_history') }}">条件クリア</a>
        <button class="btn" type="submit">検索</button>
      </div>
    </div>
  </form>

  <div class="table-wrap card">
    {% if records %}
      <table>
        <thead>
          <tr>
            <th class="col-title">曲名</th>
            <th class="col-score">スコア</th>
            <th class="col-user">ユーザー名</th>
            <th class="col-singer">歌手名</th>
            <th class="col-date">日付</th>
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
            {% set u = r["ユーザー"] %}
            {% set bar = 'bar-green' if u=='まつりく' else ('bar-cyan' if u=='えす' else 'bar-violet') %}
            {% set chip = 'chip-green' if u=='まつりく' else ('chip-cyan' if u=='えす' else 'chip-violet') %}
            <tr class="{{ bar }}">
              <td><span class="truncate">{{ r["曲名"] }}</span></td>
              <td class="nowrap"><span class="score compact">{{ '%.3f'|format(r["スコア"]) }}</span></td>
              <td><span class="uname-chip {{ chip }}">{{ u }}</span></td>
              <td class="col-singer">{{ r["歌手名"] }}</td>
              <td class="col-date">{{ r["日付"]|fmtdate("%Y-%m-%d %H:%M") }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="muted" style="margin-top:8px">全 {{ total }} 件</div>

      <div class="pager">
        <span class="info">全 {{ total }} 件 / {{ page }} / {{ total_pages }} ページ</span>
        {% if page > 1 %}
          <a class="btn secondary"
             href="{{ url_for('all_history',
                               song=song_query,
                               singer=singer_query,
                               sort=sort,
                               per=per,
                               page=page-1) }}">前へ</a>
        {% endif %}
        {% if page < total_pages %}
          <a class="btn"
             href="{{ url_for('all_history',
                               song=song_query,
                               singer=singer_query,
                               sort=sort,
                               per=per,
                               page=page+1) }}">次へ</a>
        {% endif %}
      </div>
    {% else %}
      <div class="muted">データがありません</div>
    {% endif %}
  </div>
{% endblock %}

