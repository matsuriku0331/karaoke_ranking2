{% extends "base.html" %}
{% block title %}管理画面 | 根性カラオキ{% endblock %}

{% block content %}
  <div class="h1">管理画面</div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="card" style="margin-bottom:16px">
        {% for cat, msg in messages %}
          <div class="muted">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- 検索 -->
  <form class="card" method="get" action="{{ url_for('admin') }}" style="margin-bottom:16px">
    <div class="grid cols-3">
      <div>
        <label for="q_song">曲名検索</label>
        <input type="text" id="q_song" name="song" placeholder="例：天使" value="{{ q_song }}">
      </div>
      <div>
        <label for="q_user">ユーザー検索</label>
        <input type="text" id="q_user" name="user" placeholder="例：まつりく" value="{{ q_user }}">
      </div>
      <div>
        <label for="q_singer">歌手名検索</label>
        <input type="text" id="q_singer" name="singer" placeholder="例：高橋洋子" value="{{ q_singer }}">
      </div>
    </div>
    <div class="row" style="margin-top:12px; justify-content:flex-end">
      <a class="btn secondary" href="{{ url_for('admin') }}">条件クリア</a>
      <button class="btn" type="submit">検索</button>
    </div>
  </form>

  <!-- 追加フォーム -->
  <div class="card" style="margin-bottom:16px">
    <div class="h1" style="margin-top:0">手動で1件追加</div>
    <form method="post" action="{{ url_for('admin_add') }}">
      <div class="grid cols-3">
        <div>
          <label for="song">曲名 *</label>
          <input type="text" id="song" name="song" placeholder="曲名" required>
        </div>
        <div>
          <label for="singer">歌手名</label>
          <input type="text" id="singer" name="singer" placeholder="歌手名（任意）">
        </div>
        <div>
          <label for="user">ユーザー *</label>
          <input type="text" id="user" name="user" placeholder="例：まつりく" required>
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:12px">
        <div>
          <label for="score">スコア *</label>
          <input type="text" id="score" name="score" placeholder="例：98.72" required>
        </div>
        <div>
          <label for="date">日付 *</label>
          <input type="datetime-local" id="date" name="date" required>
        </div>
        <div style="display:flex; align-items:flex-end; justify-content:flex-end">
          <button class="btn" type="submit">追加</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px; font-size:12px">
        * 必須。日時は「YYYY-MM-DDTHH:MM」形式（例：2025-09-07T21:30）。DBには時刻まで保存されます。
      </div>
    </form>
  </div>

  <!-- 一覧（最新200件） -->
  <div class="card">
    <div class="song-head" style="margin-bottom:4px">
      <div class="song-title">最新データ（最大200件）</div>
      <a class="btn secondary" href="{{ url_for('admin_logout') }}">ログアウト</a>
    </div>

    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th style="min-width:60px">ID</th>
            <th style="min-width:180px">曲名</th>
            <th style="min-width:160px">歌手名</th>
            <th style="min-width:120px">ユーザー</th>
            <th style="min-width:90px">スコア</th>
            <th style="min-width:160px">日付</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.song }}</td>
              <td>{{ r.singer }}</td>
              <td>{{ r.user }}</td>
              <td>{{ '%.2f'|format(r.score) }}</td>
              <td>{{ r.date.strftime('%Y-%m-%d %H:%M') if r.date }}</td>
            </tr>
          {% endfor %}
          {% if not rows %}
            <tr><td colspan="6" class="muted">データがありません。</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}